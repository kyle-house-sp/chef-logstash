# This file was created for <%= node.name %>
# by Chef
# Manual changes will be lost
input {
  lumberjack {
    port => 6514
    ssl_certificate => "/etc/ssl/certs/<%= node['service']['ssl_key_name'] %>.crt"
    ssl_key => "/etc/ssl/private/<%= node['service']['ssl_key_name'] %>.key"
  }
}

filter {
  if [type] == "syslog" {
    grok {
      #match => { "message" => "%{URIHOST}:%{BASE16FLOAT}%{ISO8601_TIMEZONE} %{TOKEN:token} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}: %{GREEDYDATA:syslog_message}" }
      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}: %{GREEDYDATA:syslog_message}" }
      add_field => [ "received_at", "%{@timestamp}" ]
      add_field => [ "received_from", "%{host}" ]
    }
    syslog_pri { }
    date {
      match => [ "syslog_timestamp", "MMM  d HH:mm:ss", "MMM dd HH:mm:ss" ]
    }
  }
}

filter {
  if [token] != "<%= node['logstash']['token'] %>" {
    drop { }
  }
}

filter {
  if [syslog_message] =~ /timestamp/ {
    json {
      source => "syslog_message"
    }
  }
}

filter {
  if [syslog_message] =~ /noConfig.jsp/ {
    mutate {
      add_tag => ['alert']
    }
  }
}

output {
  elasticsearch {
    host => "<%= node['logstash']['es_endpoint'] %>"
    cluster => "<%= node['logstash']['es_cluster'] %>"
  }
  if 'alert' in [tags]  {
    pagerduty {
      service_key => '3483262c595743a7a2ebb96b298ba93d'
      description => 'No Configuration Found'
    }
  }
}
